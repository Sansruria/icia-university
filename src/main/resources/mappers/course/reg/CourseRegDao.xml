<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="kr.ac.icia.dao.course.reg.CourseRegDao">

	<select id="findByCondition" parameterType="kr.ac.icia.dto.course.CourseSearchDto" resultType="kr.ac.icia.dto.course.reg.CourseRegDto">
		SELECT * FROM (SELECT rownum AS rnum, a.* FROM (SELECT
															s.course_id         AS courseId,
															s.department_id     AS deptId,
															d.department_name   AS deptName,
															s.pf_id             AS pfId,
															pf.pf_name          AS pfName,
															s.course_division   AS courseDivision,
															s.course_name       AS courseName,
															s.limit_max_count   AS limitMaxCount,
															s.credit,
															s.grade,
															s.semester,
															s.course_day        AS courseDay,
															s.course_start_time AS courseStartTime,
															s.course_end_time   AS courseEndTime,
															s.create_date       AS createDate
														FROM subject s
															 JOIN department d ON d.department_id = s.department_id
															 JOIN pf ON pf.pf_id = s.pf_id
															 LEFT OUTER JOIN course_request req ON req.course_id = s.course_id
														WHERE
														    s.grade <![CDATA[ <= ]]> #{grade} AND s.semester <![CDATA[ <= ]]> #{semester}
														    AND
															s.course_id NOT IN (SELECT course_id FROM course_request WHERE st_id = (SELECT st_id FROM st WHERE st_id = #{stId}))

														<if test="courseId != null and courseId != ''">
															AND UPPER(s.course_id) LIKE '%'||UPPER(#{courseId})||'%'
														</if>

														<if test="courseName != null and courseName != ''">
															AND UPPER(s.course_name) LIKE '%'||UPPER(#{courseName})||'%'
														</if>

														<if test="courseDivision != null and courseDivision != ''">
															AND UPPER(s.course_division) LIKE '%'||UPPER(#{courseDivision})||'%'
														</if>

														<if test="deptName != null and deptName != ''">
															AND UPPER(d.department_name) LIKE '%'||UPPER(#{deptName})||'%'
														</if>

														<if test="pfName != null and pfName != ''">
															AND UPPER(pf.pf_name) LIKE '%'||UPPER(#{pfName})||'%'
														</if>

														ORDER BY s.create_date DESC) a)
		WHERE rnum BETWEEN #{start} AND #{end}
	</select>

	<select id="findAllCount" parameterType="kr.ac.icia.dto.course.CourseSearchDto" resultType="Integer">
		SELECT COUNT(*) FROM (SELECT s.course_id       AS courseId,
									s.department_id   AS deptId,
									d.department_name AS deptName,
									s.pf_id           AS pfId,
									pf.pf_name        AS pfName,
									s.course_division AS courseDivision,
									s.course_name     AS courseName
								FROM subject s
									JOIN pf ON pf.pf_id = s.pf_id
									JOIN department d ON d.department_id = s.department_id
								WHERE s.grade <![CDATA[ <= ]]> #{grade} AND s.semester <![CDATA[ <= ]]> #{semester}

								<if test="courseId != null and courseId != ''">
									AND UPPER(s.course_id) LIKE '%'||UPPER(#{courseId})||'%'
								</if>

								<if test="courseName != null and courseName != ''">
									AND UPPER(s.course_name) LIKE '%'||UPPER(#{courseName})||'%'
								</if>

								<if test="courseDivision != null and courseDivision != ''">
									AND UPPER(s.course_division) LIKE '%'||UPPER(#{courseDivision})||'%'
								</if>

								<if test="deptName != null and deptName != ''">
									AND UPPER(d.department_name) LIKE '%'||UPPER(#{deptName})||'%'
								</if>

								<if test="pfName != null and pfName != ''">
									AND UPPER(pf.pf_name) LIKE '%'||UPPER(#{pfName})||'%'
								</if>

								)
	</select>

	<insert id="applyCourse" parameterType="kr.ac.icia.dto.course.reg.CourseRegDto">
		INSERT INTO course_request (req_course_id, course_id, st_id)
		VALUES (#{reqCourseId}, #{courseId}, #{stId})
	</insert>

</mapper>