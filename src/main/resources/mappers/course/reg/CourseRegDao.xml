<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="kr.ac.icia.dao.course.reg.CourseRegDao">

	<select id="findByCondition" parameterType="kr.ac.icia.dto.course.CourseSearchDto" resultType="kr.ac.icia.dto.course.reg.CourseRegDto">
		SELECT * FROM (SELECT rownum AS rnum, a.* FROM (SELECT
															s.course_id         AS courseId,
															s.department_id     AS deptId,
															d.department_name   AS deptName,
															s.pf_id             AS pfId,
															pf.pf_name          AS pfName,
															s.course_division   AS courseDivision,
															s.course_name       AS courseName,
															s.limit_max_count   AS limitMaxCount,
															s.credit,
															s.grade,
															s.semester,
															s.course_day        AS courseDay,
															s.course_start_time AS courseStartTime,
															s.course_end_time   AS courseEndTime,
															s.create_date       AS createDate,
															req.req_course_id   AS reqCourseId,
															req.req_grade       AS reqGrade,
															req.req_semester    AS reqSemester,
															req.reapply
														FROM subject s
															 JOIN department d ON d.department_id = s.department_id
															 JOIN pf ON pf.pf_id = s.pf_id
															 LEFT OUTER JOIN course_request req ON req.st_id = #{stId} AND req.course_id = s.course_id
														WHERE
															req.reapply IS NULL OR req.reapply <![CDATA[ <> ]]> 'Y'
															OR
															req.req_grade <![CDATA[ <> ]]> #{grade} OR req.req_semester <![CDATA[ <> ]]> #{semester}

														<if test="courseId != null and courseId != ''">
															AND UPPER(s.course_id) LIKE '%'||UPPER(#{courseId})||'%'
														</if>

														<if test="courseName != null and courseName != ''">
															AND UPPER(s.course_name) LIKE '%'||UPPER(#{courseName})||'%'
														</if>

														<if test="courseDivision != null and courseDivision != ''">
															AND UPPER(s.course_division) LIKE '%'||UPPER(#{courseDivision})||'%'
														</if>

														<if test="deptName != null and deptName != ''">
															AND UPPER(d.department_name) LIKE '%'||UPPER(#{deptName})||'%'
														</if>

														<if test="pfName != null and pfName != ''">
															AND UPPER(pf.pf_name) LIKE '%'||UPPER(#{pfName})||'%'
														</if>

														ORDER BY

														    <if test='semester == "1"'>
														    	CASE WHEN s.grade = #{grade} THEN 1 END,
															</if>

															<if test='semester == "2"'>
																CASE WHEN s.grade = #{grade} AND s.semester = '2' THEN 1
																     WHEN s.grade = #{grade} AND s.semester = '1' THEN 2 END,
															</if>

														    s.grade, s.semester, s.course_division) a)
		WHERE rnum BETWEEN #{start} AND #{end}
	</select>

	<select id="findAllCount" parameterType="kr.ac.icia.dto.course.CourseSearchDto" resultType="Integer">
		SELECT COUNT(*) FROM (SELECT s.course_id       AS courseId,
									s.department_id   AS deptId,
									d.department_name AS deptName,
									s.pf_id           AS pfId,
									pf.pf_name        AS pfName,
									s.course_division AS courseDivision,
									s.course_name     AS courseName
								FROM subject s
									JOIN pf ON pf.pf_id = s.pf_id
									JOIN department d ON d.department_id = s.department_id
									LEFT OUTER JOIN course_request req ON req.st_id = #{stId} AND req.course_id = s.course_id
								WHERE
									req.reapply IS NULL OR req.reapply <![CDATA[ <> ]]> 'Y'
									OR
									req.req_grade <![CDATA[ <> ]]> #{grade} OR req.req_semester <![CDATA[ <> ]]> #{semester}

								<if test="courseId != null and courseId != ''">
									AND UPPER(s.course_id) LIKE '%'||UPPER(#{courseId})||'%'
								</if>

								<if test="courseName != null and courseName != ''">
									AND UPPER(s.course_name) LIKE '%'||UPPER(#{courseName})||'%'
								</if>

								<if test="courseDivision != null and courseDivision != ''">
									AND UPPER(s.course_division) LIKE '%'||UPPER(#{courseDivision})||'%'
								</if>

								<if test="deptName != null and deptName != ''">
									AND UPPER(d.department_name) LIKE '%'||UPPER(#{deptName})||'%'
								</if>

								<if test="pfName != null and pfName != ''">
									AND UPPER(pf.pf_name) LIKE '%'||UPPER(#{pfName})||'%'
								</if>

								)
	</select>

	<insert id="applyCourse" parameterType="kr.ac.icia.dto.course.reg.CourseRegDto">
		INSERT INTO course_request (req_course_id, course_id, st_id, req_grade, req_semester, reapply, create_date)
		VALUES (#{reqCourseId}, #{courseId}, #{stId}, #{grade}, #{semester}, #{reapply}, DEFAULT)
	</insert>

	<update id="reapplyCourse" parameterType="kr.ac.icia.dto.course.reg.CourseRegDto">
		UPDATE course_request SET reapply = #{reapply} WHERE req_course_id = #{reqCourseId}
	</update>

</mapper>